name: AZ cli

on:
  push

         
permissions:
      id-token: write
      contents: read        

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      RG: 'RG-dev'

    steps:

    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v2

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{secrets.Azure_Login}}

    - name: Azure CLI Action
      uses: Azure/cli@v1.0.9
      with:
        azcliversion: 2.37.0
        inlineScript: |
            az group list --output table >> whatif

      # Create string output of Whatif
    - name: Create String Output
      id: whatif-string
      run: |
        WHATIF=$(cat whatif)
        
        delimiter="$(openssl rand -hex 8)"
        echo "summary<<${delimiter}" >> $GITHUB_OUTPUT
        echo "## RESOURCE GROUP LIST" >> $GITHUB_OUTPUT
        echo "<details><summary>Click to expand</summary>" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo '```' >> $GITHUB_OUTPUT
        echo "$WHATIF" >> $GITHUB_OUTPUT
        echo '```' >> $GITHUB_OUTPUT
        echo "</details>" >> $GITHUB_OUTPUT
        echo "${delimiter}" >> $GITHUB_OUTPUT


    - name: Publish Whatif to Task Summary
      env:
        SUMMARY: ${{ steps.whatif-string.outputs.summary }}
      run: |
        echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY


    - name: Azure CLI Action
      uses: Azure/cli@v1.0.9
      with:
        azcliversion: 2.37.0
        inlineScript: |
            az logout
